
<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Luna – assistente locale (v1.4a)</title>
<style>
:root{
  --bg1:#0e0f16; --bg2:#151826;
  --surface:#1d2133; --bubble:#232844;
  --text:#e7ecff; --muted:#aab3d9; --accent:#6c84ff; --ok:#44d17c; --warn:#f8c146; --err:#ff6b6b;
}
*{box-sizing:border-box} html,body{height:100%}
body{
  margin:0; color:var(--text); background: radial-gradient(circle at 20% -10%,var(--bg2),var(--bg1));
  font: 16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Calibri,sans-serif;
  display:flex; flex-direction:column; align-items:center;
}
.app{width:100%; max-width:860px; padding:16px 14px 22px}
header{display:flex; align-items:center; justify-content:space-between; gap:12px; margin:4px 0 8px}
h1{margin:0; font-size: clamp(20px,4.8vw,28px); letter-spacing:0.3px}
.badge{display:flex; align-items:center; gap:8px; font-size:13px; color:var(--muted)}
.badge .state{display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:99px; background: #20253c;}
.state b{font-weight:600}

#settingsBtn{all:unset; display:grid; place-items:center; width:40px; height:40px; border-radius:12px;
  background:var(--surface); cursor:pointer}
#settingsBtn:active{transform:scale(.98)}

.chat{
  background: linear-gradient(180deg,#161a2a 0%, #121628 100%);
  border:1px solid #262b49; border-radius:16px; min-height:58vh; padding:14px; overflow:hidden;
  display:flex; flex-direction:column; gap:10px;
}
.msg{max-width:92%; padding:10px 12px; border-radius:12px; box-shadow:0 1px 0 rgba(0,0,0,.15)}
.me{align-self:flex-end; background:#1f2645}
.ai{align-self:flex-start; background:var(--bubble)}
.msg small{display:block; color:var(--muted); margin-top:6px; font-size:12px}

.footer{
  position:sticky; bottom:0; background:transparent; padding-top:12px
}
.row{display:flex; gap:8px}
input[type=text]{
  flex:1; padding:12px 14px; border-radius:12px; outline:none;
  background:var(--surface); border:1px solid #2a3154; color:var(--text)
}
button.primary{
  border:0; background:var(--accent); color:white; padding:12px 16px; border-radius:12px; font-weight:600; cursor:pointer
}
.iconbtn{border:1px solid #2a3154; background:var(--surface); color:var(--text); border-radius:12px; width:48px; height:48px}
.iconbtn[disabled]{opacity:.55; cursor:not-allowed}

.hint{margin-top:8px; color:var(--muted); font-size:12px}
kbd{background:#2a3154; padding:1px 6px; border-radius:6px}

.micBadge{
  display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:10px; font-size:12px;
  background:#1b2037; border:1px solid #2a3154;
}
.micDot{width:10px; height:10px; border-radius:50%; background:#6572a8}
.micDot.live{background:var(--ok); box-shadow:0 0 0 6px rgba(68,209,124,.15)}
.meter{height:8px; width:72px; background:#20253c; border-radius:6px; overflow:hidden}
.meter > i{display:block; height:100%; width:0%; background:linear-gradient(90deg,#65d17e,#6c84ff)}

#panel{
  position:fixed; inset:auto 0 0 0; transform:translateY(100%); transition:transform .25s;
  background:#0e1120; border-top:1px solid #2a3154; padding:16px; max-height:86vh; overflow:auto
}
#panel.open{transform:none}
.panelTitle{display:flex; align-items:center; justify-content:space-between}
.grid{display:grid; gap:12px; grid-template-columns:1fr}
fieldset{border:1px solid #2a3154; border-radius:12px; padding:12px}
legend{color:var(--muted)}
label{display:block; margin:6px 0 4px}
select,input[type=range],input[type=text].mini{
  width:100%; padding:10px; border-radius:10px; background:#171c30; border:1px solid #2a3154; color:var(--text)
}
.switch{display:flex; align-items:center; gap:8px}
.switch input{transform:scale(1.2)}
.small{color:var(--muted); font-size:12px}
hr.sep{border:0; border-top:1px dashed #2a3154; margin:10px 0}
a.link{color:#9db1ff; text-decoration:none}
.themeRow{display:flex; gap:8px; flex-wrap:wrap}
.themeRow button{border:1px solid #2a3154; background:#171c30; color:var(--text); padding:8px 10px; border-radius:10px}
.themeRow button.active{outline:2px solid var(--accent)}
</style>
</head>
<body>
<div class="app">
  <header>
    <div>
      <h1>🌙 <span id="assistantName">Luna</span></h1>
      <div class="badge">
        <span class="state"><b>Stato:</b> <span id="providerState">Locale</span></span>
        <span class="micBadge"><span class="micDot" id="micDot"></span> <span id="micText">Idle</span> <span class="meter"><i id="vu"></i></span></span>
      </div>
    </div>
    <button id="settingsBtn" title="Impostazioni">⚙️</button>
  </header>

  <main class="chat" id="chat" aria-live="polite">
    <div class="msg ai">
      Ciao! Sono <b id="who">Luna</b>. Scrivimi, oppure premi 🎤 per parlare. Posso leggere le risposte con 🔊.
      <small>Consigli: “voce femminile”, “cambia nome in Aurora”, “apri impostazioni”.</small>
    </div>
  </main>

  <div class="footer">
    <div class="row">
      <input id="input" type="text" placeholder="Scrivi un messaggio per Luna…" autocomplete="off" />
      <button class="primary" id="sendBtn">Invia</button>
      <button class="iconbtn" id="speakBtn" title="Parla (tieni premuto su iOS se necessario)">🎤</button>
      <button class="iconbtn" id="ttsBtn" title="Leggi l’ultimo messaggio">🔊</button>
    </div>
    <div class="hint">Modalità: <b id="modeHint">Testo</b>. Parlo solo quando il microfono è attivo o quando premi <kbd>🔊</kbd>.</div>
  </div>
</div>

<!-- pannello impostazioni -->
<aside id="panel" aria-modal="true" aria-hidden="true">
  <div class="panelTitle">
    <h3>Impostazioni di Luna</h3>
    <button id="closePanel" class="iconbtn">✖️</button>
  </div>
  <div class="grid">
    <fieldset>
      <legend>Identità</legend>
      <label>Nome assistente</label>
      <div class="row">
        <input id="nameInput" class="mini" type="text" placeholder="Luna" />
        <button class="iconbtn" id="nameApply" title="Applica">✅</button>
      </div>
      <div class="small">Comando vocale rapido: “cambia nome in …”.</div>
    </fieldset>

    <fieldset>
      <legend>Voce</legend>
      <label>Seleziona voce (preferita: Federica)</label>
      <select id="voiceSelect"></select>
      <label>Velocità</label><input id="rate" type="range" min="0.6" max="1.2" step="0.01">
      <label>Tono</label><input id="pitch" type="range" min="0.8" max="1.2" step="0.01">
      <div class="small">Profilo consigliato Federica: velocità 0.96 • tono 1.04.</div>
      <hr class="sep">
      <div class="switch"><input type="checkbox" id="speakOnlyWhenMic"><label for="speakOnlyWhenMic">Parla solo con microfono attivo</label></div>
    </fieldset>

    <fieldset>
      <legend>Tema</legend>
      <div class="themeRow" id="themeRow">
        <button data-theme="dark" class="active">Scuro</button>
        <button data-theme="light">Chiaro</button>
        <button data-theme="midnight">Notte blu</button>
      </div>
    </fieldset>

    <fieldset>
      <legend>Avanzate</legend>
      <div class="small">Provider: <b id="providerInfo">Locale (browser)</b>. Futuri agganci: cloud/locale.</div>
      <div class="switch"><input type="checkbox" id="confirmBeforeSpeak"><label for="confirmBeforeSpeak">Conferma lettura quando non è stato premuto il microfono</label></div>
      <button id="resetBtn">Ripristina impostazioni</button>
    </fieldset>
  </div>
</aside>

<script>
/* ============ util ============ */
const $ = s => document.querySelector(s);
const chat = $("#chat"), input = $("#input");
function addMsg(text, who='ai'){
  const div=document.createElement('div');
  div.className='msg '+(who==='me'?'me':'ai');
  div.innerHTML = text;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
  return div;
}
function setBadge(state){ $("#micText").textContent=state; }
function setDot(live){ $("#micDot").classList.toggle('live', !!live); }
function clamp(n,min,max){ return Math.max(min,Math.min(max,n)); }

/* ============ settings & memory ============ */
const store = {
  get(){ try{return JSON.parse(localStorage.getItem('luna-settings')||'{}')}catch(_){return {}} },
  set(v){ localStorage.setItem('luna-settings', JSON.stringify(v)); }
};
const S = Object.assign({
  name:'Luna', speakOnlyWhenMic:true, confirmBeforeSpeak:true,
  rate:0.96, pitch:1.04, voiceName:'Federica', theme:'dark'
}, store.get());

function applyTheme(theme){
  const t = theme || S.theme;
  if(t==='light'){
    document.documentElement.style.setProperty('--bg1','#f6f9ff');
    document.documentElement.style.setProperty('--bg2','#e7edff');
    document.documentElement.style.setProperty('--surface','#ffffff');
    document.documentElement.style.setProperty('--bubble','#f2f5ff');
    document.documentElement.style.setProperty('--text','#0e1020');
    document.documentElement.style.setProperty('--muted','#4b5580');
  }else if(t==='midnight'){
    document.documentElement.style.setProperty('--bg1','#0a0b12');
    document.documentElement.style.setProperty('--bg2','#0f1430');
    document.documentElement.style.setProperty('--surface','#121735');
    document.documentElement.style.setProperty('--bubble','#1a2150');
    document.documentElement.style.setProperty('--text','#eaf0ff');
    document.documentElement.style.setProperty('--muted','#96a2d9');
  }else{ // dark (default)
    document.documentElement.style.cssText = '';
  }
}
applyTheme();

/* ============ name & panel ============ */
$("#assistantName").textContent = S.name; $("#who").textContent=S.name;
$("#settingsBtn").onclick=()=>$("#panel").classList.add('open');
$("#closePanel").onclick=()=>$("#panel").classList.remove('open');
$("#nameInput").value=S.name;
$("#nameApply").onclick=()=>{
  const v=$("#nameInput").value.trim()||'Luna';
  S.name=v; store.set(S);
  $("#assistantName").textContent=v; $("#who").textContent=v;
  addMsg(`Nome aggiornato in <b>${v}</b>.`);
};
$("#themeRow").addEventListener('click',e=>{
  if(e.target.tagName!=='BUTTON')return;
  [...e.currentTarget.children].forEach(b=>b.classList.remove('active'));
  e.target.classList.add('active');
  S.theme=e.target.dataset.theme; store.set(S); applyTheme();
});

/* ============ voices (TTS) ============ */
const voiceSelect=$("#voiceSelect"); const ttsBtn=$("#ttsBtn");
let voices=[]; let selectedVoice=null;
function loadVoices(){
  voices = speechSynthesis.getVoices().filter(v=>v.lang.startsWith('it'));
  // preferisci Federica
  let preferred = voices.find(v=>/federica/i.test(v.name)) || voices[0];
  voiceSelect.innerHTML = '';
  // Mostra solo poche voci curate, Federica in cima
  const curated = [];
  if(preferred) curated.push(preferred);
  voices.forEach(v=>{ if(!curated.find(x=>x.name===v.name) && curated.length<3) curated.push(v); });
  curated.forEach(v=>{
    const opt=document.createElement('option');
    opt.value=v.name; opt.textContent=v.name + (v.default?' (predefinita)':'');
    voiceSelect.appendChild(opt);
  });
  // selezione iniziale
  const byName = curated.find(v=>v.name.includes(S.voiceName)) || preferred || curated[0];
  if(byName){ voiceSelect.value = byName.name; selectedVoice=byName; }
}
window.speechSynthesis.onvoiceschanged = loadVoices; loadVoices();

voiceSelect.onchange=()=>{ selectedVoice = speechSynthesis.getVoices().find(v=>v.name===voiceSelect.value); S.voiceName=selectedVoice?.name||S.voiceName; store.set(S); };
$("#rate").value=S.rate; $("#pitch").value=S.pitch;
$("#rate").oninput=e=>{ S.rate=+e.target.value; store.set(S); };
$("#pitch").oninput=e=>{ S.pitch=+e.target.value; store.set(S); };
$("#speakOnlyWhenMic").checked=S.speakOnlyWhenMic;
$("#speakOnlyWhenMic").onchange=e=>{ S.speakOnlyWhenMic=e.target.checked; store.set(S); };
$("#confirmBeforeSpeak").checked=S.confirmBeforeSpeak;
$("#confirmBeforeSpeak").onchange=e=>{ S.confirmBeforeSpeak=e.target.checked; store.set(S); };

$("#resetBtn").onclick=()=>{
  localStorage.removeItem('luna-settings'); location.reload();
};

/* ============ speak helper ============ */
function speak(text){
  if(!text) return;
  const u = new SpeechSynthesisUtterance(text);
  u.voice = selectedVoice || speechSynthesis.getVoices().find(v=>/federica/i.test(v.name));
  u.lang = 'it-IT';
  u.rate = S.rate; u.pitch = S.pitch;
  speechSynthesis.cancel(); speechSynthesis.speak(u);
}

/* ============ simple NLU ============ */
function replyTo(input){
  const t = input.toLowerCase().trim();

  // saluti/mi senti
  if(/(ciao|buongiorno|buonasera)/.test(t)) return "Ciao! Tutto bene, sono qui. Come posso aiutarti?";
  if(/(mi senti|sei li|ci sei)/.test(t)) return "Sì, ti sento. Dimmi pure.";
  if(/come stai/.test(t)) return "Sto bene, grazie! Pronta a darti una mano.";

  // impostazioni rapide
  const m = t.match(/cambia nome in (.+)$/i); if(m){ const newName=m[1].trim(); $("#nameInput").value=newName; $("#nameApply").click(); return `Ok, da ora mi chiamo ${newName}.`; }
  if(/voce femminile/.test(t)) { // già federica, conferma
    return "Uso la voce femminile. Se vuoi posso parlare un po’ più dolce o più energica.";
  }
  if(/apri impostazioni/.test(t)) { $("#panel").classList.add('open'); return "Apro le impostazioni."; }
  if(/chiudi impostazioni/.test(t)) { $("#panel").classList.remove('open'); return "Chiuso."; }
  if(/(tema|colore).*(scuro)/.test(t)){ S.theme='dark'; store.set(S); applyTheme(); return "Imposto il tema scuro."; }
  if(/(tema|colore).*(chiaro)/.test(t)){ S.theme='light'; store.set(S); applyTheme(); return "Imposto il tema chiaro."; }

  // fallback
  return "Ricevuto. Vuoi che faccia qualcosa in particolare?";
}

/* ============ STT (microfono) ============ */
const speakBtn=$("#speakBtn"); const vu=$("#vu"); const modeHint=$("#modeHint");
let rec=null, listening=false, meterInt=null;
function supportedSTT(){ return ('webkitSpeechRecognition' in window) || ('SpeechRecognition' in window); }

function startMic(){
  if(listening) return;
  if(!supportedSTT()){ addMsg("Il riconoscimento vocale non è supportato da questo browser.",'ai'); return; }
  const R = window.SpeechRecognition || window.webkitSpeechRecognition;
  rec = new R(); rec.lang='it-IT'; rec.interimResults=true; rec.continuous=false;
  let buffer='';

  rec.onstart=()=>{ listening=true; setBadge('Ascolto'); setDot(true); modeHint.textContent='Voce'; animateMeter(); };
  rec.onresult=e=>{
    let final='';
    for(let i=e.resultIndex;i<e.results.length;i++){
      const res=e.results[i];
      if(res.isFinal){ final += res[0].transcript; }
      else { buffer = res[0].transcript; }
    }
    if(final){
      stopMeter();
      setDot(false); setBadge('Elaboro…');
      addMsg(final,'me');
      const out = replyTo(final);
      const node = addMsg(out,'ai');
      if(!S.speakOnlyWhenMic || (S.speakOnlyWhenMic && listening)) speak(out);
      setBadge('Pronta');
    }
  };
  rec.onerror=e=>{ stopMeter(); setDot(false); setBadge('Errore microfono'); console.warn(e); };
  rec.onend=()=>{ listening=false; stopMeter(); setDot(false); setBadge('Pronta'); };

  rec.start();
}
function stopMic(){ if(rec){ try{rec.stop();}catch(_){}} }
function animateMeter(){
  stopMeter();
  meterInt=setInterval(()=>{ const w = Math.floor(Math.random()*70)+10; vu.style.width=w+'%'; }, 80);
}
function stopMeter(){ if(meterInt){ clearInterval(meterInt); meterInt=null; } vu.style.width='0%'; }

speakBtn.onclick=()=>{
  if(listening){ stopMic(); }
  else { startMic(); }
}

/* ============ send text ============ */
$("#sendBtn").onclick=sendText;
input.addEventListener('keydown',e=>{ if(e.key==='Enter'){ sendText(); }});
function sendText(){
  const v = input.value.trim(); if(!v) return;
  addMsg(v, 'me'); input.value='';
  const out = replyTo(v);
  const node = addMsg(out,'ai');
  if(!S.speakOnlyWhenMic){
    if(S.confirmBeforeSpeak){ /* solo su richiesta esplicita */
      // non parlare automaticamente
    } else { speak(out); }
  }
}

/* ============ read last ============ */
ttsBtn.onclick=()=>{
  const last = [...document.querySelectorAll('.msg.ai')].pop();
  if(!last) return;
  speak(last.textContent.trim());
};

/* ============ initial UI ============ */
$("#providerState").textContent='Locale';
$("#providerInfo").textContent='Locale (Web Speech API)';
$("#modeHint").textContent = S.speakOnlyWhenMic ? 'Testo (voce con microfono)' : 'Testo+Voce';
setBadge('Pronta');
</script>
</body>
</html>