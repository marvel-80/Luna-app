<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Luna ‚Äî Assistente</title>
<style>
:root{
  --bg1:#0d0d1a; --bg2:#14162a; --panel:#0b1220; --line:#1e2a45;
  --text:#e6e6fa; --muted:#9fb0d9; --accent:#6c63ff; --me:#1d3a63;
}
*{box-sizing:border-box}
body{margin:0;min-height:100vh;background:radial-gradient(circle at 20% -10%,var(--bg2),var(--bg1));
     color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;display:flex;flex-direction:column}
header{position:sticky;top:0;background:linear-gradient(180deg,rgba(0,0,0,.45),rgba(0,0,0,.1));
       backdrop-filter:blur(6px);border-bottom:1px solid var(--line);padding:12px 16px;display:flex;align-items:center;gap:10px}
h1{margin:0;font-size:20px;color:#aab7ff}
.badge{font-size:12px;color:var(--muted)}
.container{max-width:900px;margin:14px auto;padding:0 14px;display:grid;grid-template-columns:1fr;gap:14px}
.card{background:var(--panel);border:1px solid var(--line);border-radius:12px;box-shadow:0 6px 24px rgba(0,0,0,.25)}
.chat{padding:12px;max-height:52vh;overflow:auto;display:flex;flex-direction:column;gap:10px}
.bubble{padding:10px 12px;border-radius:12px;max-width:85%}
.luna{align-self:flex-start;background:#0f1a30;border:1px solid var(--line)}
.user{align-self:flex-end;background:var(--me)}
.bar{display:flex;gap:8px;padding:12px;border-top:1px solid var(--line)}
input[type=text]{flex:1;padding:10px;border-radius:10px;border:1px solid var(--line);background:#0e172b;color:var(--text)}
button{padding:10px 14px;border-radius:10px;border:1px solid var(--line);background:#101b33;color:var(--text);cursor:pointer}
button.primary{background:var(--accent);border-color:transparent;color:#fff}
.small{font-size:12px;color:var(--muted)}
/* Settings modal */
#settings{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:10;align-items:flex-start;justify-content:center}
#settings .box{background:#fff;color:#0b1220;border-radius:12px;border:1px solid #d8e1f0;margin-top:6vh;max-width:560px;width:92%;padding:14px}
#settings .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
#settings label{font-size:13px;color:#334}
#settings input[type=text],#settings select,#settings input[type=range]{width:100%;padding:8px;border:1px solid #c7d2e5;border-radius:8px}
#gear{margin-left:auto}
@media (max-width:700px){#settings .grid{grid-template-columns:1fr}}
</style>
</head>
<body>
  <header>
    <h1 id="title">Luna</h1>
    <span class="badge">Chat & Voce locale</span>
    <button id="gear">‚öôÔ∏è</button>
  </header>

  <div class="container">
    <div class="card">
      <div id="chat" class="chat" aria-live="polite"></div>
      <div class="bar">
        <input id="msg" type="text" placeholder="Scrivi un messaggio per Luna‚Ä¶">
        <button id="send" class="primary">Invia</button>
        <button id="speak" title="Ripeti ultima risposta">üîä</button>
        <button id="mic" title="Dettatura">üé§</button>
      </div>
      <div class="small" style="padding:0 12px 12px">
        Comandi vocali: ‚Äú<em>cambia nome in Aurora</em>‚Äù, ‚Äú<em>voce femminile</em> / <em>voce maschile</em>‚Äù,
        ‚Äú<em>apri impostazioni</em>‚Äù, ‚Äú<em>chiudi impostazioni</em>‚Äù, ‚Äú<em>velocit√† 1.1</em>‚Äù, ‚Äú<em>tono 1.05</em>‚Äù.
      </div>
    </div>
  </div>

  <!-- Settings -->
  <div id="settings">
    <div class="box">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <strong>Impostazioni</strong>
        <button id="closeSettings">Chiudi</button>
      </div>

      <div class="grid">
        <div>
          <label>Nome assistente</label>
          <input id="nameInput" type="text" placeholder="Luna">
        </div>
        <div>
          <label>Voce</label>
          <select id="voiceSelect"></select>
          <div class="small">Suggerite: femm. Alice/Silvia/Federica ¬∑ masc. Luca/Paolo/Vittorio (se presenti sul dispositivo).</div>
        </div>
        <div>
          <label>Velocit√†</label>
          <input id="rate" type="range" min="0.8" max="1.3" step="0.01" value="1.0">
        </div>
        <div>
          <label>Tono (pitch)</label>
          <input id="pitch" type="range" min="0.8" max="1.3" step="0.01" value="1.05">
        </div>
        <div>
          <label>Tema</label>
          <select id="themeSelect">
            <option value="auto">Auto (segue sistema)</option>
            <option value="scuro">Scuro</option>
            <option value="chiaro">Chiaro</option>
          </select>
        </div>
      </div>

      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:12px">
        <button id="saveSettings" class="primary">Salva</button>
      </div>
    </div>
  </div>

<script>
/* ========== Stato & Storage ========== */
const LS_KEY='luna_settings_v13';
const chatEl = document.getElementById('chat');
const msgEl  = document.getElementById('msg');
function load(){ try{ return JSON.parse(localStorage.getItem(LS_KEY))||{name:'Luna',voice:null,rate:1,pitch:1.05,theme:'auto'} }catch{return {name:'Luna',voice:null,rate:1,pitch:1.05,theme:'auto'}}}
function save(s){ localStorage.setItem(LS_KEY, JSON.stringify(s)); }
function bubble(t,who='luna'){ const d=document.createElement('div'); d.className='bubble '+(who==='user'?'user':'luna'); d.textContent=t; chatEl.appendChild(d); chatEl.scrollTop=chatEl.scrollHeight; }

/* ========== UI apply ========== */
function applySettings(s){
  document.getElementById('title').textContent = s.name||'Luna';
  document.getElementById('nameInput').value = s.name||'Luna';
  document.getElementById('rate').value = s.rate||1;
  document.getElementById('pitch').value = s.pitch||1.05;
  document.getElementById('themeSelect').value = s.theme||'auto';
  if(s.theme==='scuro'){ document.documentElement.style.colorScheme='dark'; }
  else if(s.theme==='chiaro'){ document.documentElement.style.colorScheme='light'; }
  else { document.documentElement.style.colorScheme='normal'; }
}

/* ========== TTS ========== */
let voices=[];
function populateVoices(){
  voices = speechSynthesis.getVoices();
  const sel=document.getElementById('voiceSelect'); if(!sel) return;
  sel.innerHTML='';
  // preferisci 3 fem + 3 masc se esistono
  const pref = ['Alice','Silvia','Federica','Luca','Paolo','Vittorio'];
  const it = voices.filter(v=>/it/i.test(v.lang));
  const sorted=[...pref.map(n=>it.find(v=>v.name.includes(n))).filter(Boolean),...it.filter(v=>!pref.some(n=>v.name.includes(n)))];
  for(const v of sorted){ const o=document.createElement('option'); o.value=v.name; o.textContent=`${v.name} (${v.lang})`; sel.appendChild(o); }
  const s=load(); if(s.voice && sorted.find(v=>v.name===s.voice)) sel.value=s.voice;
}
if('speechSynthesis' in window){ speechSynthesis.onvoiceschanged=populateVoices; setTimeout(populateVoices,300); }

function speak(text){
  if(!('speechSynthesis' in window)) return;
  const s=load();
  const u=new SpeechSynthesisUtterance(text);
  u.lang='it-IT';
  u.rate=s.rate||1; u.pitch=s.pitch||1.05;
  if(s.voice){ const v=voices.find(v=>v.name===s.voice); if(v) u.voice=v; }
  else{ const v=voices.find(v=>/it/i.test(v.lang)); if(v) u.voice=v; }
  speechSynthesis.cancel(); speechSynthesis.speak(u);
}

/* ========== STT + comandi ========== */
let rec=null;
function startRec(){
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR){ bubble('Il riconoscimento vocale non √® supportato su questo dispositivo.','luna'); return; }
  rec=new SR(); rec.lang='it-IT'; rec.interimResults=false; rec.maxAlternatives=1;
  rec.onresult= async (e)=>{ const text=e.results[0][0].transcript; bubble(text,'user'); if(await handleCommand(text)) return; reply(text); };
  rec.start();
}
function toNum(x){ return parseFloat(String(x).replace(',','.')); }
function clamp(v,min,max){ return Math.max(min,Math.min(max,v)); }
function capitalize(s){ return s.charAt(0).toUpperCase()+s.slice(1); }

async function handleCommand(tRaw){
  const t=tRaw.trim().toLowerCase(); let s=load(); let changed=false;
  // nome
  let m=t.match(/cambia (il )?nome (in|a)\s+(.+)/i) || t.match(/chiamami\s+(.+)/i) || t.match(/il tuo nome √®\s+(.+)/i);
  if(m){ const name=(m[3]||m[1]||m[4]||m[0]).replace(/^(in|a)\s*/,'').trim(); if(name){ s.name=capitalize(name); changed=true; } }
  // voce
  if(/voce\s+(femminile|donna)/i.test(t)){ const pick=voices.find(v=>/it/i.test(v.lang) && /(Alice|Silvia|Federica|fem|female)/i.test(v.name))||voices.find(v=>/it/i.test(v.lang)); if(pick){ s.voice=pick.name; changed=true; } }
  if(/voce\s+(maschile|uomo)/i.test(t)){ const pick=voices.find(v=>/it/i.test(v.lang) && /(Luca|Paolo|Vittorio|masch|male)/i.test(v.name))||voices.find(v=>/it/i.test(v.lang)); if(pick){ s.voice=pick.name; changed=true; } }
  // velocit√† & tono
  m=t.match(/velocit[a√†]\s*(a|=)?\s*([0-9]+[.,]?[0-9]*)/i); if(m){ s.rate=clamp(toNum(m[2]),0.8,1.3); changed=true; }
  if(/aumenta velocit/i.test(t)) { s.rate=clamp((s.rate||1)+0.05,0.8,1.3); changed=true; }
  if(/(riduci|abbassa) velocit/i.test(t)) { s.rate=clamp((s.rate||1)-0.05,0.8,1.3); changed=true; }
  m=t.match(/(tono|pitch|timbro)\s*(a|=)?\s*([0-9]+[.,]?[0-9]*)/i); if(m){ s.pitch=clamp(toNum(m[3]),0.8,1.3); changed=true; }
  // tema
  if(/tema scuro|dark/i.test(t)){ s.theme='scuro'; changed=true; }
  if(/tema chiaro|light/i.test(t)){ s.theme='chiaro'; changed=true; }
  if(/tema auto|automatico/i.test(t)){ s.theme='auto'; changed=true; }
  // impostazioni pannello
  if(/apri (le )?impostazioni/i.test(t)){ document.getElementById('settings').style.display='flex'; return true; }
  if(/chiudi (le )?impostazioni/i.test(t)){ document.getElementById('settings').style.display='none'; return true; }

  if(changed){ save(s); applySettings(s); speak('Impostazioni aggiornate.'); return true; }
  return false;
}

/* ========== Chat demo locale ========== */
function reply(text){
  const s=load();
  const r = `Ciao, sono ${s.name}. Hai detto: ‚Äú${text}‚Äù. Posso cambiare nome o voce dalle impostazioni.`;
  bubble(r,'luna'); speak(r);
}

/* ========== Eventi UI ========== */
document.getElementById('send').onclick=()=>{ const v=msgEl.value.trim(); if(!v) return; msgEl.value=''; bubble(v,'user'); handleCommand(v).then(done=>{ if(!done) reply(v); }); };
msgEl.addEventListener('keydown',(e)=>{ if(e.key==='Enter') document.getElementById('send').click(); });
document.getElementById('speak').onclick=()=>{ const last=chatEl.querySelector('.bubble.luna:last-child')?.textContent || `Ciao, sono ${load().name}.`; speak(last); };
document.getElementById('mic').onclick=startRec;

document.getElementById('gear').onclick=()=>{ document.getElementById('settings').style.display='flex'; };
document.getElementById('closeSettings').onclick=()=>{ document.getElementById('settings').style.display='none'; };
document.getElementById('saveSettings').onclick=()=>{
  const s=load();
  s.name=document.getElementById('nameInput').value.trim()||'Luna';
  s.rate=parseFloat(document.getElementById('rate').value);
  s.pitch=parseFloat(document.getElementById('pitch').value);
  s.theme=document.getElementById('themeSelect').value;
  const chosen=document.getElementById('voiceSelect').value; s.voice=chosen||null;
  save(s); applySettings(s); document.getElementById('settings').style.display='none'; speak('Impostazioni salvate.');
};

/* ========== Boot ========== */
(function boot(){
  const s=load(); applySettings(s);
  bubble('Ciao! Sono Luna. Scrivimi o usa üé§ per parlare. Posso leggere le risposte con üîä.','luna');
  populateVoices();
})();
</script>
</body>
</html>